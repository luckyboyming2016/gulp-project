define(["jquery","underscore","template","room/marker","collection","BMap"],function(t,i,e,n,o){function r(t){t=t||{},this.context=t.context,this.root=t.root,this.getTemplate=t.getTemplate,this.getOffset=t.getOffset,this.history={},this.deferQuene=[],this.ready=!1,this.collection=new o,this.flyingMarker=null,this.viewed={},this.ifOnly=t.ifOnly,this.bin=[],this.deferPromise=null}return r.prototype={constructor:r,addMarker:function(t,e,o){var r=this.point(t),s=new n(e,r);s.zoomLevel=t.zoomLevel,s.data=t,this.context.addOverlay(s),s.setAnchor(o),this.history[t.id]=s,i(this.collection.hashMap).each(function(t,e){i.isEmpty(t)||i(t).each(function(t){s.addEventListener(e,t.invoke)},this)},this)},point:function(t){return t.lat||t.lng||console.warn("经纬度数据异常: \n"+JSON.stringify(t)),new BMap.Point(t.lng,t.lat)},setMarkers:function(t,n,o){t=t||[],o||(this.bin=i.clone(t),this.removeAll(),t.length,this.currZoomLevel=n);var r=e.render(this.getTemplate(n));i(t).each(function(t){if(t.communityId&&(t.id=t.id||t.communityId),t.id||(t.id=Math.floor(1e10*Math.random())),null==this.history[t.id]){var i=this.getOffset(n,t);t.zoomLevel=n,t.root=this.root,this.viewed[t.id]&&(t.viewed=this.viewed[t.id]),this.addMarker(t,r(t),i)}},this),o||(this.task(),this.ifOnly&&1==t.length&&this.ifOnly.call(this.getMarker(t[0].id),t[0]),t.length>0&&this.viewportAdapter())},task:function(){this.ready||(this.context.addEventListener("dragend",t.proxy(this.redraw,this)),this.ready=!0),i(this.deferQuene).each(function(t){t.invoke(this.history[t.key]?this.history[t.key].data:null),t.invoke=null},this),this.deferQuene=[]},removeAll:function(){i(this.history).each(function(t){this.context.removeOverlay(t),t=null},this),this.history={},this.bin=[]},setContext:function(t){this.context=t},index:function(t){return this.history[t]||null},setRoot:function(t){this.root=t},query:function(t,i,e){var n;e?i(this.history[t]||null):this.ready?(n=this.history[t],i(null==n?null:n.data)):this.deferQuene.push({invoke:i,key:t})},on:function(t,e,n){this.collection.on(t,e,n),i(this.history).each(function(i){i.addEventListener(t,e)},this)},off:function(t,e){this.collection.off(t,e),i(this.history).each(function(i){i.removeEventListener(t,e)},this)},getMarker:function(t){return this.history[t]||null},setMarkerCenter:function(t){var i=null;if(null==(i=t instanceof BMapLib.RichMarker?t:this.history[t])||!i.data)return this;var e=i.data.lng,n=i.data.lat;if(!e||!n)return console.warn("marker无法居中，因为没有经纬度 "),this;this.collection.trigger("sign",new BMap.Point(e,n))},fly:function(t){null!=this.flyingMarker&&this.flyingMarker.fall(),t.fly(),this.flyingMarker=t},fall:function(){null!=this.flyingMarker&&(this.flyingMarker.fall(),this.flyingMarker=null)},open:function(t){null!=this.flyingMarker&&this.flyingMarker.close(),t.open()},close:function(t){null!=this.flyingMarker&&(this.flyingMarker.close(),this.flyingMarker=null)},addClicked:function(t){i(this.viewed).each(function(t,i){var e=this.history[i];null!=e&&e.viewed(!0).close().fall()},this),this.viewed[t.data.id]?this.viewed[t.data.id]+=1:this.viewed[t.data.id]=1},viewportAdapter:function(){var e=this.context.getBounds();if(i(this.history).every(function(t){return!e.containsPoint(t.getPosition())}))for(var n in this.history){this.collection.trigger("sign",this.history[n].getPosition()),setTimeout(t.proxy(function(){this.collection.trigger("sign",this.history[n].getPosition())},this),400);break}},filter:function(t,e){return e=e||this.context.getBounds(),i(t||[]).filter(function(t){return!(!t.lng||!t.lng)&&e.containsPoint(new BMap.Point(t.lng,t.lat))})},redraw:function(){"community"==this.currZoomLevel&&this.deferPromise?this.deferPromise.done(t.proxy(function(t){this.setMarkers(this.filter(t.communities),this.currZoomLevel,!0)},this)):this.setMarkers(this.filter(this.bin),this.currZoomLevel,!0)}},r});